# US 05 - As a medical lab technician, I want to record samples collected in the scope of a given test.

## 1. Requirements Engineering

*In this section, it is suggested to capture the requirement description and specifications as provided by the client as well as any further clarification on it. It is also suggested to capture the requirements acceptance criteria and existing dependencies to other requirements. At last, identfy the involved input and output data and depicted an Actor-System interaction in order to fulfill the requirement.*


### 1.1. User Story Description

As a medical lab technician, I want to record samples collected in the scope of a given test.

### 1.2. Customer Specifications and Clarifications 

From the Specifications Document:

* "(...) until a medical lab technician calls him/her to collect the samples required to perform a given test." (n√£o sei se deve estar aqui)
* "All the tests (clinical blood tests and Covid-19 tests) performed by the network of laboratories are registered locally by the medical lab technicians who collect the samples."
* "When sampling (blood or swab) the medical lab technician records the samples in the system, associating the samples with the client/test, and identifying each sample with a barcode that is automatically generated using an external API."

From the client clarifications:


* Question: "What kind of attributes should a sample have? // Can a test have more than one sample? // We didn't fully understand what will the API do in this US, so here's out interpretation from the US, correct us if we're wrong please: The API will be generated randomly and the API is an attribute from the sample."
  * [Answer:](https://moodle.isep.ipp.pt/mod/forum/discuss.php?d=8244#p10782) "Each sample is associated with a test. A sample has only one attribute, a barcode number (UPC) that is a sequential number and is automatically generated by the system. Each sample has a unique barcode number. In US5, the medical lab technician checks the system and see all tests for which there are no samples collected. The medical lab technician selects a test and the system asks for the number of samples to collect. // Yes. // The API will be used to generate/print barcodes."
  
  
* Question: "What information does the medical lab technician needs to input to the record a new sample?"
  * [Answer:](https://moodle.isep.ipp.pt/mod/forum/discuss.php?d=8360#p10930) "The medical lab technician checks a list of tests and selects one. Then, the application generates barcodes (one or more). After printing the barcodes (one or more) the use case ends."

  
* Question: "It was answered in one of the previous questions that the sample only has one attribute, the barcode, however the description of the project also mentions a date of collection of the samples, is this date supposed to be an attribute of the test and not of the sample itself? // If there were multiple samples for a single test, would there be only one collection date for all of them?"
  * [Answer:](https://moodle.isep.ipp.pt/mod/forum/discuss.php?d=8450#p11069) "Yes. The system should record the date (DD/MM/YYYY) and time (HH:MM) when the sample is collect made. The date and time are automatically generated by the system when the barcode is issued. // Only one collection date and time for a test."


* Question: "Why is there the specification for only the tests with no samples? // Shouldn't there be a way for technicians to add more samples to an existing test? // Should there be a validation of the number of samples? // After the barcodes are generated. The concept-reality link would be, for example to stick each barcode into each sample?"
  * [Answer:](https://moodle.isep.ipp.pt/mod/forum/discuss.php?d=8437#p11052) "The Medical Lab Technician selects a tests and the number of barcodes he/she wants. Then the system generates the requested barcodes. After generating the barcodes, the select test is no more available in the system for generating barcodes. // No. // No. // Yes. Each generated barcode should be saved in a folder as a jpeg file."


* Question: "Is there a specific order/priority for the medical lab technician to select the test to which he wants to collect the samples, or is the selection random? If there is an order, how is a test chosen?"
  * [Answer:](https://moodle.isep.ipp.pt/mod/forum/discuss.php?d=8541#p11196) "The medical lab technician selects the test and the system generates the barcodes."


* Question: "During the current sprint, how should we allow the barcodes to be printed. After generating them via the API, should we save the barcode images to the disk?"
  * [Answer:](https://moodle.isep.ipp.pt/mod/forum/discuss.php?d=8491#p11119) "Each generated barcode should be saved in a folder as a jpeg file."


* Question: "What information does the medical lab technician needs to input to the record a new sample?"
  * [Answer:](https://moodle.isep.ipp.pt/mod/forum/discuss.php?d=8360#p10930) "The medical lab technician checks a list of tests and selects one. Then, the application generates barcodes (one or more). After printing the barcodes (one or more) the use case ends."  


* Question: "What is supposed to show to the Medical Lab Technician when he selects the pretended test ?"
  * [Answer:](https://moodle.isep.ipp.pt/mod/forum/discuss.php?d=8583#p11247) "Firstly, the Medical Lab Technician checks the system to see the tests/clients that need to be done. Before selecting a test, the Medical Lab Technician checks/see the name of the client and all the test data (test attributes, test type, collection method, parameters, etc.). Then, the Medical Lab Technician selects one test/client and the system asks for the number of samples to collect. Next, the system generates the barcodes to put in the samples."


* Question: "Regarding US5, after selecting the number of samples for the test chosen by the medical lab tec., should the barcodes be displayed on the screen, or just printed and saved?"
  * [Answer:](https://moodle.isep.ipp.pt/mod/forum/discuss.php?d=8589#p11253) "Should be saved in a file."
  

### 1.3. Acceptance Criteria

* AC1:"The system should support several barcode APIs. The API to use is defined by configuration."
* AC2:"A sample has only one attribute, a barcode number (UPC) that is a sequential number and is automatically generated by the system."
* AC3:"Each sample has a unique barcode number."
* AC4:"Each generated barcode should be saved in a folder as a jpeg file."

### 1.4. Found out Dependencies

* There is a dependency to "US04  As a receptionist of the laboratory, I intend to register a test to be performed to a registered client." since at least a test must be registered to associate samples to it.

### 1.5 Input and Output Data

Input Data

* Typed data:

  * Number of samples to be collected


* Selected data:

  * Test


Output Data

* List of tests with no samples collected
* (In)Success of the operation


### 1.6. System Sequence Diagram (SSD)


![US05-SSD](US05-SSD.svg)


### 1.7 Other Relevant Remarks

This US uses external modules, so the barcodes can be generated.

## 2. OO Analysis

### 2.1. Relevant Domain Model Excerpt 

![US05-MD](US05-MD.svg)

### 2.2. Other Remarks



## 3. Design - User Story Realization 

### 3.1. Rationale

**The rationale grounds on the SSD interactions and the identified input/output data.**

| Interaction ID | Question: Which class is responsible for... | Answer  | Justification (with patterns)  |
|:-------------  |:--------------------- |:------------|:---------------------------- |
| Step 1: asks to record new sample(s) | ... interacting with the actor? | RecordSamplesUI         | Pure Fabrication: there is no reason to assign this responsibility to any existing class in the Domain Model |
|                                      | ... creating a new sample?      | Test                    | Creator: According to the Domain Model, a Test aggregates sample                                             |
|                                      | ... coordinating the US?        | RecordSamplesController | Controller                                                                                                   |
| Step 2: shows the tests and requests data (i.e.: test, number of samples to be collected) |	... knowing the tests to show? | RecordSamplesUI and TestStore | IE and Creator: UI is responsible for showing it and the Test Store is able to retrieve the available tests. |
| Step 3: selects one test and types requested data | ... knowing TestStore?        | Company | IE: Company knows the TestStore to which it is delegating some tasks |
| Step 4: shows the data (samples generated and test to be associated with) and requests a confirmation | ... generating the barcode(s)?            | ExternalModuleAPIBarcode | Protected Variations: because this is a point of variation and instability, it was found necessary to create a stable interface to decrease this point of variation |              
|                                                                                                       | ... requesting the barcode(s) to the API? | APIBarcodeAdapter        | HC+LC |
|                                                                                                       | ... saving the barcode generated?         | Sample                   | IE: a sample knows its data |
| Step 5: confirms the data | ...validating the data locally (e.g.: mandatory vs. non-mandatory data)? | Sample    | IE: is able to validate a new sample |              
|                           | ...validating the data globally (e.g.: duplicated)?                      | TestStore | IE: knows all the test objects which may contain samples    |
|                           | ...saving the created sample(s)?                                         | Test      | IE: records all its sample objects   |
| Step 6: informs operation success | ... informing	operation success? | RecordSamplesUI | IE: is responsible for user interactions |

### Systematization ##

According to the taken rationale, the conceptual classes promoted to software classes are: 

 * Test
 * Sample
 * Company
 * ExternalModuleAPIBarcode
 * APIBarcodeAdapter

Other software classes (i.e. Pure Fabrication) identified: 
 
 * RecordSamplesUI  
 * RecordSamplesController
 * TestStore

## 3.2. Sequence Diagram (SD)


![US05-SD](US05-SD.svg)

## 3.3. Class Diagram (CD)


![US05-CD](US05-CD.svg)

# 4. Tests

**Test 1:** Check the method isListUnique present in the Test class. 

	@Test
    public void isListUniqueFalse() throws BarcodeException {
        app.domain.model.Test t = new app.domain.model.Test();
        List<Barcode> list = new ArrayList<>();
        Barcode b1=new UPCABarcode("12345678901");
        Barcode b2=new UPCABarcode("12345678901");
        list.add(b1);
        list.add(b2);
        boolean expected=false;
        boolean result=t.isListUnique(list);
        assertEquals(expected,result);
    }

    @Test
    public void isListUniqueTrue() throws BarcodeException {
        app.domain.model.Test t = new app.domain.model.Test();
        List<Barcode> list = new ArrayList<>();
        Barcode b1=new UPCABarcode("12345678901");
        Barcode b2=new UPCABarcode("12364778908");
        list.add(b1);
        list.add(b2);
        boolean expected=true;
        boolean result=t.isListUnique(list);
        assertEquals(expected,result);
    }

**Test 2:** Check the method globallyUnique present in the TestStore class.

    @Test
    public void globallyUniqueTrue() throws BarcodeException {
        TestStore ts = new TestStore();
        app.domain.model.Test t = new app.domain.model.Test();
        ts.addTest(t);
        Barcode b1 = new UPCABarcode("12548796324");
        Barcode b2 = new UPCABarcode("78965412352");
        List<Barcode> barcodeList = new ArrayList<>();
        barcodeList.add(b1);
        barcodeList.add(b2);
        t.addAll(barcodeList);
        t.create();
        app.domain.model.Test t1 = new app.domain.model.Test();
        ts.addTest(t1);
        Barcode b3 = new UPCABarcode("78945612301");
        Barcode b4 = new UPCABarcode("45678912304");
        List<Barcode> barcodeList1 = new ArrayList<>();
        barcodeList1.add(b3);
        barcodeList1.add(b4);
        boolean expected = true;
        boolean result = ts.globallyUnique(barcodeList1);
        assertEquals(expected, result);
    }

    @Test
    public void globallyUniqueFalse() throws BarcodeException {
        TestStore ts = new TestStore();
        app.domain.model.Test t = new app.domain.model.Test();
        ts.addTest(t);
        Barcode b1 = new UPCABarcode("12548796324");
        Barcode b2 = new UPCABarcode("78965412352");
        List<Barcode> barcodeList = new ArrayList<>();
        barcodeList.add(b1);
        barcodeList.add(b2);
        t.addAll(barcodeList);
        t.create();
        app.domain.model.Test t1 = new app.domain.model.Test();
        ts.addTest(t1);
        Barcode b3 = new UPCABarcode("12548796324");
        Barcode b4 = new UPCABarcode("45678912304");
        List<Barcode> barcodeList1 = new ArrayList<>();
        barcodeList1.add(b3);
        barcodeList1.add(b4);
        boolean expected = false;
        boolean result = ts.globallyUnique(barcodeList1);
        assertEquals(expected, result);
    }

# 5. Construction (Implementation)

**RecordSamplesController**

    public class RecordSamplesController{
      private App app;
      private Company company;
      private TestStore testStore;
      private Test test;
      private List<Test> testList;
      private List<TestDto> testDtoList;
      private String tCode;
      private boolean bool1=false;
      private boolean bool2=false;
      private List<Barcode> listBarcodes;
      private TestDto testDto;
      private APIBarcodeAdapter adapter;

      public RecordSamplesController() throws Exception {
      }

      public List<TestDto> getRegisteredTests(){
      }

      public TestDto recordSample(TestDto tDto, int nSamples) throws Exception {
      }

      public void deleteBarcode(int nSamples) throws Exception{
      }

      public boolean save(){
      }
    }

**Company**

    public class Company{
      private TestStore testStore;
      //...(omitted)

      public TestStore getTestStore (){
      }
    }

**TestStore**

    public class TestStore{
      private List<Test> TestList;

      public List<Test> getRegisteredTests(){
      }

      public Test getTest(String code){
      }

      public boolean globallyUnique(List<Barcode> listBarcodes){
      }
    }

**TestMapper**

    public class TestMapper{
      public static List<TestDto> ModelToDto (List<Test> listTest){
      }
    
      public static TestDto ModelToDto (Test test){
      }
    
      public static String DtoToModel (TestDto testDto){
      }
    }

**Test**

    public class Test{
      private Status state;
    
      private List<Barcode> testBarcodesList = new ArrayList<>();
    
      private ArrayList<Sample> listSamples = new ArrayList<>();
    
      private Date collectDateTime;
    
      public void updateTestStatus(){
      }
    
      public boolean isListUnique(List<Barcode> listBarcodes){
      }
    
      public void addAll(List<Barcode> listBarcodes){
      }
    
      public List<Sample> create(){
      }
    
      public void updateCollectDateTime(){
      }
    
      public boolean validate(){
      }
    }

**APIBarcodeAdapter**

    public class APIBarcodeAdapter {
      private ExternalModuleAPIBarcode barcode;
    
      public APIBarcodeAdapter() throws Exception{
      }
    
      public List<Barcode> generateBarcodes(int nSamples, boolean a) throws Exception {
      }
    }

**ExternalModuleAPIBarcode**
    
    public interface ExternalModuleAPIBarcode{
      List<Barcode> generate(int nSamples, boolean a) throws Exception;
    }

**ExternalModuleAPIBarcode1**

    public class ExternalModuleAPIBarcode1 implements ExternalModuleAPIBarcode{
      private int nSamples;

      private int nBarcodes=0;

      private boolean a;

      private String fileName;

      private File outputFile;

      private String path;

      private String barcodeCode;

      private List<Barcode> barcodeGenerated;

      public ExternalModuleAPIBarcode1 () throws Exception{
      }

      public List<Barcode> generate(int nSamples, boolean a) throws Exception {
      }

      public static String generateFileName(int totalBarcodes){
      }

      public void writeBarcode(BufferedImage image){
      }

      public void deleteBarcode(){
      }
    }

**Sample**

    public class Sample {
      private Barcode barcode;

      public Sample(Barcode barcode){
      }

      public Sample (){
      }

      public Barcode getBarcode(){
      }
    }

# 6. Integration and Demo 

A new menu was added, for the Medical Lab Technician, with one option.


# 7. Observations

The developed work was made in order to allow an easy implementation of future changes.




